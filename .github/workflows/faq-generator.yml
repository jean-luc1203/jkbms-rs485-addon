name: FAQ Generator

on:
  issues:
    types: [closed]
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate FAQ from issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              labels: 'resolved,question',
              per_page: 100,
              sort: 'comments',
              direction: 'desc'
            });
            
            const categories = {
              hardware: { title: 'Hardware & Connections', icon: 'ğŸ”Œ', issues: [] },
              config: { title: 'Configuration', icon: 'âš™ï¸', issues: [] },
              mqtt: { title: 'MQTT & Integrations', icon: 'ğŸ“¡', issues: [] },
              gateway: { title: 'IP Gateway', icon: 'ğŸŒ', issues: [] },
              can: { title: 'CAN Bus', icon: 'ğŸ”Œ', issues: [] },
              errors: { title: 'Common Errors', icon: 'ğŸ›', issues: [] },
              other: { title: 'Other Questions', icon: 'â“', issues: [] }
            };
            
            issues.forEach(issue => {
              const text = (issue.title + ' ' + (issue.body || '')).toLowerCase();
              let category = 'other';
              
              if (text.match(/ttyusb|ttyacm|usb|port|cable|rs485|converter|adapter|wiring|led/)) {
                category = 'hardware';
              } else if (text.match(/mqtt|broker|mosquitto|connection|entities|unavailable/)) {
                category = 'mqtt';
              } else if (text.match(/gateway|ip|ethernet|wifi|tcp|network/)) {
                category = 'gateway';
              } else if (text.match(/can|canbus/)) {
                category = 'can';
              } else if (text.match(/config|yaml|parameter|settings|mode|master|listen|broadcasting/)) {
                category = 'config';
              } else if (text.match(/error|bug|crash|fail|timeout|crc|modbus|invalid|range/)) {
                category = 'errors';
              }
              
              categories[category].issues.push({
                title: issue.title,
                number: issue.number,
                comments: issue.comments,
                reactions: issue.reactions.total_count,
                url: issue.html_url
              });
            });
            
            const date = new Date().toISOString().split('T')[0];
            let faq = '# ğŸ“š FAQ - JKBMS RS485 Addon\n\n';
            faq += '> ğŸ¤– Automatically generated from resolved issues\n';
            faq += '> Last update: ' + date + '\n';
            faq += '> Total resolved issues: ' + issues.length + '\n\n';
            faq += '## ğŸ” Quick Navigation\n\n';
            
            for (const [key, cat] of Object.entries(categories)) {
              if (cat.issues.length > 0) {
                faq += '- [' + cat.icon + ' ' + cat.title + ' (' + cat.issues.length + ')](#' + key + ')\n';
              }
            }
            faq += '\n---\n\n';
            
            for (const [key, cat] of Object.entries(categories)) {
              if (cat.issues.length === 0) continue;
              
              faq += '## ' + cat.icon + ' ' + cat.title + ' {#' + key + '}\n\n';
              
              cat.issues
                .sort((a, b) => (b.reactions + b.comments) - (a.reactions + a.comments))
                .slice(0, 15)
                .forEach(issue => {
                  faq += '### ' + issue.title + '\n\n';
                  faq += '**[Issue #' + issue.number + '](' + issue.url + ')** | ';
                  faq += 'ğŸ’¬ ' + issue.comments + ' comments | ';
                  faq += 'ğŸ‘ ' + issue.reactions + ' reactions\n\n';
                  faq += '[ğŸ“– View full discussion and solution](' + issue.url + ')\n\n';
                  faq += '---\n\n';
                });
            }
            
            faq += '## ğŸ’¡ Your question is not listed here?\n\n';
            faq += '1. ğŸ” [Search all issues](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/issues?q=is%3Aissue)\n';
            faq += '2. ğŸ’¬ [Ask in Discussions](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/discussions)\n';
            faq += '3. ğŸ› [Create a new issue](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/issues/new/choose)\n\n';
            faq += '## ğŸ†˜ Priority Support\n\n';
            faq += 'Need urgent help with guaranteed response time?\n\n';
            faq += '- ğŸ’¬ **Community Support** (free): 3-7 days response via GitHub\n';
            faq += '- ğŸ’ **Supporter** ($5/month): 48h response + Discord access\n';
            faq += '- ğŸ‘” **Pro Support** ($25/month): 24h response + remote assistance\n\n';
            faq += 'ğŸ‘‰ [Get priority support on Ko-fi](https://ko-fi.com/Y8Y3YHYZP)\n\n';
            faq += '---\n\n';
            faq += '*This FAQ is automatically updated when issues are closed with "resolved" or "question" labels.*\n';
            
            fs.writeFileSync('FAQ.md', faq);
            console.log('Generated FAQ with ' + issues.length + ' issues');
      
      - name: Commit FAQ
        run: |
          git config user.name "FAQ Bot"
          git config user.email "actions@github.com"
          git add FAQ.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Update FAQ from resolved issues"
            git push
          fi
