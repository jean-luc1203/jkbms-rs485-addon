name: Generate FAQ from closed issues

on:
  issues:
    types: [closed]
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight
  workflow_dispatch:  # Manual trigger

jobs:
  generate-faq:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate FAQ
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Fetch all closed issues with "resolved" or "question" labels
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              labels: 'resolved,question',
              per_page: 100,
              sort: 'comments',
              direction: 'desc'
            });
            
            // Group by categories
            const categories = {
              hardware: { title: 'ğŸ”Œ Hardware & Connections', issues: [] },
              config: { title: 'âš™ï¸ Configuration', issues: [] },
              mqtt: { title: 'ğŸ“¡ MQTT & Integrations', issues: [] },
              gateway: { title: 'ğŸŒ IP Gateway', issues: [] },
              can: { title: 'ğŸ”Œ CAN Bus', issues: [] },
              errors: { title: 'ğŸ› Common Errors', issues: [] },
              other: { title: 'â“ Other Questions', issues: [] }
            };
            
            // Classify issues
            issues.forEach(issue => {
              const title = issue.title.toLowerCase();
              const body = (issue.body || '').toLowerCase();
              const text = title + ' ' + body;
              
              let category = 'other';
              
              if (text.match(/ttyusb|ttyacm|usb|port|cable|rs485|converter|adapter|wiring|led/)) {
                category = 'hardware';
              } else if (text.match(/mqtt|broker|mosquitto|connection|entities|unavailable/)) {
                category = 'mqtt';
              } else if (text.match(/gateway|ip|ethernet|wifi|tcp|network/)) {
                category = 'gateway';
              } else if (text.match(/can|canbus/)) {
                category = 'can';
              } else if (text.match(/config|yaml|parameter|settings|mode|master|listen/)) {
                category = 'config';
              } else if (text.match(/error|bug|crash|fail|timeout|crc|modbus/)) {
                category = 'errors';
              }
              
              // Extract solution (last comment before closure or auto-resolved)
              const solution = issue.comments > 0 ? 
                `[View solution](${issue.html_url})` : 
                'Auto-resolved';
              
              categories[category].issues.push({
                title: issue.title,
                url: issue.html_url,
                number: issue.number,
                comments: issue.comments,
                reactions: issue.reactions.total_count,
                solution: solution,
                closed_at: issue.closed_at
              });
            });
            
            // Generate markdown
            let faqContent = `# ğŸ“š Automatic FAQ - JKBMS RS485

> ğŸ¤– This FAQ is automatically generated from resolved issues.
> Last update: ${new Date().toISOString().split('T')[0]}

## ğŸ” Quick Navigation

${Object.entries(categories).map(([key, cat]) => 
  `- [${cat.title}](#${key})`
).join('\n')}

---

`;

            // Add each category
            for (const [key, category] of Object.entries(categories)) {
              if (category.issues.length === 0) continue;
              
              faqContent += `## ${category.title} {#${key}}\n\n`;
              
              // Sort by relevance (reactions + comments)
              category.issues
                .sort((a, b) => (b.reactions + b.comments) - (a.reactions + a.comments))
                .slice(0, 10)  // Top 10 per category
                .forEach(issue => {
                  faqContent += `### ${issue.title}\n\n`;
                  faqContent += `**Issue #${issue.number}** | `;
                  faqContent += `ğŸ’¬ ${issue.comments} comments | `;
                  faqContent += `ğŸ‘ ${issue.reactions} reactions\n\n`;
                  faqContent += `${issue.solution}\n\n`;
                  faqContent += `---\n\n`;
                });
            }
            
            // Add footer
            faqContent += `
## ğŸ’¡ Your question is not here?

1. **Search in [all issues](https://github.com/${context.repo.owner}/${context.repo.repo}/issues?q=is%3Aissue)**
2. **Ask in [Discussions](https://github.com/${context.repo.owner}/${context.repo.repo}/discussions)**
3. **Create a [new issue](https://github.com/${context.repo.owner}/${context.repo.repo}/issues/new/choose)** using the template

## ğŸ†˜ Priority Support

Need urgent help (response < 24h)?

ğŸ‘‰ [Priority Support on Ko-fi](https://ko-fi.com/Y8Y3YHYZP)

**Support tiers:**
- ğŸ’¬ **Community** (free): Response within 3-7 days via GitHub/Discussions
- ğŸ’ **Supporter** ($5/month): Response within 48h + Discord access
- ğŸ‘” **Pro** ($25/month): Response within 24h + remote config help

---

## ğŸ“Š Statistics

- **Total resolved issues:** ${issues.length}
- **Hardware issues:** ${categories.hardware.issues.length}
- **Configuration issues:** ${categories.config.issues.length}
- **MQTT issues:** ${categories.mqtt.issues.length}
- **Gateway issues:** ${categories.gateway.issues.length}
- **CAN Bus issues:** ${categories.can.issues.length}
- **Error issues:** ${categories.errors.issues.length}

---

*FAQ automatically generated from closed issues - Contribute by resolving issues!*

**Want to help?** Answer questions on GitHub and help users solve their problems. 
Your contributions make this FAQ better for everyone! â¤ï¸
`;

            // Save the file
            fs.writeFileSync('FAQ.md', faqContent);
            
            console.log('âœ… FAQ generated successfully');
            console.log(`ğŸ“Š Statistics:`);
            for (const [key, cat] of Object.entries(categories)) {
              console.log(`   ${cat.title}: ${cat.issues.length} issues`);
            }
      
      - name: Commit FAQ
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "FAQ Bot"
          git add FAQ.md
          if ! git diff --quiet || ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– Auto-update FAQ from resolved issues"
            git push
          else
            echo "No changes to commit"
          fi
