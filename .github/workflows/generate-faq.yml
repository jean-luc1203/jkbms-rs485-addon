name: Generate FAQ from closed issues

on:
  issues:
    types: [closed]
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  generate-faq:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate FAQ
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              labels: 'resolved,question',
              per_page: 100,
              sort: 'comments',
              direction: 'desc'
            });
            
            const categories = {
              hardware: { title: 'ğŸ”Œ Hardware & Connections', issues: [] },
              config: { title: 'âš™ï¸ Configuration', issues: [] },
              mqtt: { title: 'ğŸ“¡ MQTT & Integrations', issues: [] },
              gateway: { title: 'ğŸŒ IP Gateway', issues: [] },
              can: { title: 'ğŸ”Œ CAN Bus', issues: [] },
              errors: { title: 'ğŸ› Common Errors', issues: [] },
              other: { title: 'â“ Other Questions', issues: [] }
            };
            
            issues.forEach(issue => {
              const title = issue.title.toLowerCase();
              const body = (issue.body || '').toLowerCase();
              const text = title + ' ' + body;
              
              let category = 'other';
              
              if (text.match(/ttyusb|ttyacm|usb|port|cable|rs485|converter|adapter|wiring|led/)) {
                category = 'hardware';
              } else if (text.match(/mqtt|broker|mosquitto|connection|entities|unavailable/)) {
                category = 'mqtt';
              } else if (text.match(/gateway|ip|ethernet|wifi|tcp|network/)) {
                category = 'gateway';
              } else if (text.match(/can|canbus/)) {
                category = 'can';
              } else if (text.match(/config|yaml|parameter|settings|mode|master|listen/)) {
                category = 'config';
              } else if (text.match(/error|bug|crash|fail|timeout|crc|modbus/)) {
                category = 'errors';
              }
              
              const solution = issue.comments > 0 ? '[View solution](' + issue.html_url + ')' : 'Auto-resolved';
              
              categories[category].issues.push({
                title: issue.title,
                url: issue.html_url,
                number: issue.number,
                comments: issue.comments,
                reactions: issue.reactions.total_count,
                solution: solution,
                closed_at: issue.closed_at
              });
            });
            
            const today = new Date().toISOString().split('T')[0];
            let faqContent = '# ğŸ“š Automatic FAQ - JKBMS RS485\n\n';
            faqContent += '> ğŸ¤– This FAQ is automatically generated from resolved issues.\n';
            faqContent += '> Last update: ' + today + '\n\n';
            faqContent += '## ğŸ” Quick Navigation\n\n';
            
            for (const [key, cat] of Object.entries(categories)) {
              faqContent += '- [' + cat.title + '](#' + key + ')\n';
            }
            
            faqContent += '\n---\n\n';

            for (const [key, category] of Object.entries(categories)) {
              if (category.issues.length === 0) continue;
              
              faqContent += '## ' + category.title + '\n\n';
              
              category.issues
                .sort((a, b) => (b.reactions + b.comments) - (a.reactions + a.comments))
                .slice(0, 10)
                .forEach(issue => {
                  faqContent += '### ' + issue.title + '\n\n';
                  faqContent += '**Issue #' + issue.number + '** | ';
                  faqContent += 'ğŸ’¬ ' + issue.comments + ' comments | ';
                  faqContent += 'ğŸ‘ ' + issue.reactions + ' reactions\n\n';
                  faqContent += issue.solution + '\n\n';
                  faqContent += '---\n\n';
                });
            }
            
            faqContent += '\n## ğŸ’¡ Your question is not here?\n\n';
            faqContent += '1. **Search in [all issues](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/issues?q=is%3Aissue)**\n';
            faqContent += '2. **Ask in [Discussions](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/discussions)**\n';
            faqContent += '3. **Create a [new issue](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/issues/new/choose)** using the template\n\n';
            faqContent += '## ğŸ†˜ Priority Support\n\n';
            faqContent += 'Need urgent help (response < 24h)?\n\n';
            faqContent += 'ğŸ‘‰ [Priority Support on Ko-fi](https://ko-fi.com/Y8Y3YHYZP)\n\n';
            faqContent += '---\n\n';
            faqContent += '*FAQ automatically generated from closed issues - Contribute by resolving issues!*\n';

            fs.writeFileSync('FAQ.md', faqContent);
            
            console.log('FAQ generated successfully');
      
      - name: Commit FAQ
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "FAQ Bot"
          git add FAQ.md
          git commit -m "Auto-update FAQ from resolved issues" || echo "No changes"
          git push || echo "Nothing to push"
